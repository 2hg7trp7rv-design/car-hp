import fs from "fs";
import path from "path";

const repoRoot = process.cwd();
const carsDir = path.join(repoRoot, "data", "articles", "cars");

function injectAtEndOfSection(body, heading, extra) {
  const marker = `## ${heading}\n`;
  const idx = body.indexOf(marker);
  if (idx === -1) return body;

  const start = idx + marker.length;
  const next = body.indexOf("\n## ", start);
  if (next === -1) {
    return `${body.trimEnd()}\n\n${extra.trim()}\n`;
  }
  return `${body.slice(0, next).trimEnd()}\n\n${extra.trim()}\n${body.slice(next)}`;
}

const usedExtras2 = {
  "nissan-gtr-r35": `### 買う店選びもスペックの一部
中古GT-Rは、車そのものより『診れる人がいるか』で価値が変わります。納車整備でどこまで見てくれるか、診断機の有無、作業の実績。ここが揃っている販売店や工場と組めると、購入後のストレスが大きく減ります。

### 迷いを減らす判断軸
- 価格より履歴。交換記録が読めない車は、将来も読めません
- 走行距離より使われ方。タイヤとブレーキの状態に揃いがあるか
- 改造は思想が読めるか。純正に戻せる範囲か
- 現車の違和感は放置しない。小さな兆候ほど早く拾う`,

  "toyota-gr-supra-rz": `### 保証と修理窓口を現実的に
電子制御が多い車は、故障そのものより切り分けが面倒です。保証の有無だけでなく、どこで診断してもらえるかを確認。近くに対応できる工場があると、結果的に維持費も時間も節約できます。

### 個体選びのコツ
- 冷間始動の音と振動を重視。温まってからだけ良い車は避ける
- 純正に近い方が基準を作りやすい。後から手を入れる方が迷いが少ない
- タイヤとブレーキの減り方を見る。走り方の履歴が読みやすい
- 記録簿の一貫性。点検間隔がバラバラなら前提を厳しめに`,

  "mazda-rx7-fd3s": `### 買う前に相談先を決める
FDは、個体を選んでから主治医を探すと遠回りになりがちです。圧縮や冷却のチェックを含めて相談できる専門店があるなら、その店が見やすい条件で車を探す方が早い。車の希少性より、整備体制の希少性が効きます。

### 初年度にやっておきたい整備の考え方
- まず冷却とホース類。温度が安定しないと全てが崩れます
- 次に油脂類。どれがいつ交換されたか不明ならリセット前提
- その次に点火と燃料。小さな不調の原因が多い領域です
- チューニングは最後。基礎が整ってからの方が結局早い`,

  "honda-integra-type-r-dc2": `### 初年度はリフレッシュに寄せる
古いタイプRは、走りを楽しむ前に『基礎の戻し』が必要な車が多い。足回りのブッシュとハブ、エンジンマウント、冷却。ここを最初に整えると、以降の整備は小さく済みます。買う時点で完璧を求めるより、リセットできる個体を選ぶのが現実的です。

### 迷いを減らすチェック
- ボディと下回りが健全か。ここが崩れている車は直しても戻りません
- 変速の違和感は厳しめに。シンクロやリンクの消耗が出ます
- 内装の欠品も見る。扱われ方の荒さが出やすい
- 改造は説明がつくか。施工店と目的が追える車を選ぶ`,

  "honda-s2000-ap1": `### 価格差は幌と足回りの差になりやすい
S2000は、走行距離より保管環境で状態が変わります。幌が綺麗で、足回りのガタが少ない車は高く見えても、直す費用で逆転しやすい。逆に、外装だけ綺麗な車は後からじわじわ出費が増えます。

### 買う時の優先順位
- 幌と雨漏りの痕跡。フロアの湿りは必ず確認
- 足回りの異音。段差で鳴るなら交換前提
- オイル管理の履歴。交換頻度が読める車が安心
- 目的に合う仕様か。街乗りなら過度な足回りは不要`,

  "subaru-impreza-wrx-sti-gc8-type-r": `### 改造の有無より、整合性
ラリー系は手が入っている車も多いですが、大事なのは説明のつく改造かどうか。施工店、目的、部品の選び方が一貫している車は扱いやすい。反対に、場当たりのパーツ寄せ集めはトラブルの起点が増えます。

### 個体選びの要点
- 下回りとボディの傷。競技ユースはここに出やすい
- 冷却と油脂管理。温度に手当がある車は信頼しやすい
- 駆動系の音。四駆は違和感が出た時の修理が重い
- タイヤ4本が揃っているか。日頃の管理が見えます`,

  "mitsubishi-lancer-evolution-vi-gsr": `### 走りの痕跡は消えません
エボは高負荷で使われることが多く、熱が入った履歴が車に残ります。ブレーキ、タイヤ、足回りの消耗が揃っているかを見て、過去の使われ方を推測。違和感がある個体は、購入後の立て直しに時間が掛かります。

### 迷いを減らす判断軸
- 水温が安定するか。渋滞で上がる車は避ける
- 駆動系の唸りや振動。小さくても放置しない
- 足回りの追従性。跳ねる個体は基礎が崩れています
- パワーより素性。まず素直に走る車から始める`,

  "nissan-skyline-gtr-r34": `### 見るべきは仕上げの丁寧さ
R34は価格よりも、整備と施工の丁寧さが差になります。配線、ホース、クランプ、下回りの処理。ここが綺麗な個体は、過去の扱い方も丁寧なことが多い。写真だけで判断せず、現車で細部を見た方が失敗が減ります。

### 個体選びのポイント
- 改造は一覧にできるか。何が変わっているかが分からない車は避ける
- 記録簿の一貫性。点検の間隔が揃っている車が安心
- 下回りのダメージ。修復歴なしでも荒れている個体があります
- 電装の後付けは丁寧か。雑な配線はトラブルの起点になります`,

  "nissan-silvia-s15": `### 直す前提でも、直しやすい個体を
安いS15をベースにする場合でも、歪みと錆が少ない車を選ぶのが最重要です。エンジンや足は後から変えられますが、骨格が崩れていると何をしても気持ち良くなりません。まずは真っ直ぐ走る個体を起点にするのが近道です。

### 迷いを減らす見方
- リア周りの異音と振動。デフとドラシャの疲労が出ます
- ボディのチリと塗装。歪みや補修の質が見えます
- 配線の取り回し。追加メーター周りが雑なら避ける
- 目的を決めてから買う。街乗りとドリフトでは必要が違います`,

  "toyota-supra-jza80-rz": `### チューニング方針が読める車が良い
JZA80はパーツが多く、前オーナーの思想が車に残ります。街乗り重視か、サーキット重視か。冷却と燃料の手当がその思想に合っているか。方向性が揃っている車はトラブルも少なく、乗っていても迷いが減ります。

### 初年度の計画を立てる
- まず油脂類と冷却を整える。年式的にここは避けられません
- 次に足回り。車重があるので基礎が崩れると怖い
- ブレーキは甘く見ない。消耗の差が走り方の差です
- パワーアップは最後。基礎が整ってからの方が結果が出ます`,

  "nissan-z-rz34": `### 新しさゆえの落とし穴
新しい車でも、短距離ばかりの使用やメンテ不足で調子を落とすことがあります。点検記録があるか、オイル交換の頻度が適切か、保証が引き継げるか。中古で安心して買うためのチェックは、古い車よりむしろ重要です。

### 個体選びのコツ
- 熱が入った痕跡を見る。タイヤとブレーキが分かりやすい
- 下回りの擦りを確認。段差で当てるとアライメントが狂います
- 慣らしと油脂管理。早い段階の扱い方が寿命に効きます
- まず基準を作る。納車後に油脂類を揃えると変化に気づけます`,

  "suzuki-alto-works-ha36s": `### 4WDかFFかで選び方が変わる
雪や雨の安心感を取るなら4WD。軽さと素直さを優先するならFF。どちらにしても、足回りの状態が走りの気持ち良さを決めます。

### 通勤系スポーツの中古で失敗しないコツ
- 過度なローダウンや極端なセッティングは避ける。街で疲れます
- ブーストアップ車は燃料と点火の手当が追えるかを見る
- クラッチのつながりと異音。渋さがあるなら交換前提
- 下回りの擦り。軽でも当てると真っ直ぐ走らなくなります
- タイヤの銘柄と減り方。雑に扱われた車はここに出ます

### 買ってから楽にするための初回メニュー
納車後は、油脂類とプラグなど基本整備を一度揃えると、その後の変化に気づきやすくなります。アルトワークスは維持費が抑えめな分、最初から先手を打てるのが強みです。`,

  "suzuki-cappuccino-ea11r": `### 錆の少ない車は、結果的に安い
塗装が綺麗でも、下回りが錆だらけだと修理のゴールが見えません。迷う二台があるなら、距離よりボディが健全な方を選ぶ価値があります。

### 錆と雨漏りの見方
- フロアとサイドシル、特にジャッキポイント周辺
- トランク床やスペアタイヤ周りの湿り
- ドア下やフェンダー内側の塗装の浮き
- 幌とウェザーストリップの劣化。雨漏りは錆を加速させます
- 室内の匂いとマット下。乾いていても痕跡は残ります

### 直しやすい個体の条件
機関は後から直せても、錆と歪みは戻りません。中古で狙うなら、ボディが良くて、改造が少なく、整備記録が断片でも残っている車。こういう個体は、結果的に早く仕上がって長く楽しめます。`,

  "honda-beat-pp1": `### 整備の入り方で価格差が出る
ビートは部品点数が限られる分、どこをリフレッシュしたかが重要です。冷却、燃料、ゴム類、足回り。整備が入っている車は高いですが、買ってから追いつくより早くて安いこともあります。

### 中古で見たいポイント
- 幌と雨漏りの痕跡。フロアの湿りは必ず確認
- 冷却水の状態。渋滞で水温が安定するか
- シフトの入り。リンクのガタがあると楽しさが落ちます
- 内装の欠品。小物が揃っている車は扱いが丁寧なことが多い
- 足回りの異音。段差で鳴るなら交換前提

### 迷ったら試乗の印象を信じる
同じビートでも、足回りのリフレッシュ具合で別物に感じます。軽い段差での収まり、低速の扱いやすさ、エンジンの始動性。ここが素直な車ほど、買ってからの整備も小さく済みます。`,

  "autozam-az-1-pg6sa": `### 欠品の洗い出しが肝
AZ-1は、機関よりも部品の欠品が悩みになります。購入前に、内装の小物、外装のモール、純正部品の有無を確認。欠品が多いほど、あとで探す時間がコストになります。

### 迷いを減らす現車チェック
- ドアヒンジと開閉のスムーズさ。ガタがあると修理が大変
- 雨漏りの痕跡。ルーフ周りとフロアの湿りを確認
- 外装の割れや欠品。補修の質も含めて見る
- 下回りの錆と補修痕。保管環境が読めます
- 付属品の有無。工具やマニュアルが残っているか

### 高くても状態の良い個体が得
希少車は『安い理由』が修理費に直結します。機関は整備で追いついても、外装と内装は時間が掛かりやすい。だからこそ、状態の良い個体ほど総額は安くなりやすいです。`,

  "lexus-lfa-2010": `### 契約書と保険まで含めて準備
LFAは車両価格だけで判断すると、維持の現実を見誤ります。保険、保管、輸送、点検の体制。ここまで整えて初めて、安心して走らせられる。見積もりを一度、具体的に出してから買うのが安全です。

### 管理履歴の読み方
- 走らせているか、保管中心か。どちらでも管理の質が重要
- タイヤの製造年。距離が少なくても時間で劣化します
- 油脂類の交換履歴。走らない車ほど劣化しやすい
- 作業の窓口が引き継げるか。主治医の有無が価値になります

### 迷いを減らす考え方
車は買えても、体制が買えないと楽しめません。購入前に、保管場所と工場と保険を具体化し、走らせる頻度までイメージできたら、判断のブレが消えます。`,

  "ferrari-f40": `### 乗らない維持もコストが掛かる
F40は距離を走らなくても、時間で劣化する箇所が多い。燃料、ゴム、シール、タイヤ。保管だけで完結しません。購入後は点検とリフレッシュを段階的に進める計画を立てておくと、想定外を減らせます。

### 迷いを減らす現実的な準備
- 真贋と履歴の整合性。曖昧な車は避ける
- 保管環境。温度と湿度で状態が変わります
- 相談できる主治医。作業の順番を組める人が必要
- 部品と作業のリードタイム。時間もコストです
- 走らせ方の計画。いきなり全開より段階を踏む

### 高い車ほど、買う前の確認が安い
購入後に発覚する問題は、金額だけでなく時間も奪います。プロに同行してもらい、疑問点を潰してから買う。F40はこの段取りが、結果的に一番安い選択です。`,

  "mercedes-benz-s-class-w140": `### 内装と電装は『全部動く』がスタートライン
シート、窓、エアコン、ロック、メーター表示。W140は快適装備が多い分、全部が繋がっています。部分的に壊れている車は、別の箇所も連鎖しやすい。

### 中古で見たいポイント
- エアコンの効きと温度調整の反応。風量が弱い車は注意
- 各モーター類。パワーシート、窓、ミラーが素直に動くか
- 警告灯の履歴。消してある車は疑う
- 試乗での変速とブレーキ。低速の違和感は拾う
- 内装の状態。擦れの強さは扱われ方の指標になります

### 迷うなら主治医から先に決める
古い高級車は、車よりも整備先が価値になります。持ち込める工場が決まれば、車の選び方も整備の進め方も一気に具体化します。工場が決まらないなら、買わない判断も賢いです。`,
};

const targets = Object.keys(usedExtras2);

for (const slug of targets) {
  const file = path.join(carsDir, `${slug}.json`);
  if (!fs.existsSync(file)) {
    console.error(`missing: ${slug}`);
    process.exitCode = 1;
    continue;
  }
  const car = JSON.parse(fs.readFileSync(file, "utf8"));
  const extra = usedExtras2[slug];
  const body = String(car.body ?? "");
  if (!body.trim()) {
    console.error(`no body to patch: ${slug}`);
    process.exitCode = 1;
    continue;
  }
  car.body = injectAtEndOfSection(body, "中古で買うなら", extra);
  fs.writeFileSync(file, JSON.stringify(car, null, 2) + "\n", "utf8");
}

console.log(`car major overhaul v3 patches applied: ${targets.length}`);
